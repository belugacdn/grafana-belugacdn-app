{"version":3,"sources":["../../src/datasource/datasource.js"],"names":["_","CryptoJS","moment","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","tokenObj","currentDimension","options","query","buildQueryParameters","targets","filter","t","hide","length","when","data","target","path","siteName","timeFrame","metricName","datasourceRequest","method","then","response","formatRawBeluga","output","series","map","item","index","datapoints","d","status","message","title","preHeader","date","tokenId","id","token","secret","toISOString","authHeader","HmacSHA512","toString","replace","annotation","annotationQuery","range","datasource","enable","iconColor","rangeRaw","result","dimension","mapToTextValue","bind","resultKeys","push","i","r","text","value","concat","refId"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\nimport CryptoJS from \"../crypto-js\";\nimport moment from \"../moment\";\n\nexport class GenericDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n\n    // Object to hold Token after auth\n    this.tokenObj = {};\n\n    // used by the mapToTextValue conversion helper\n    this.currentDimension = \"\";\n  }\n\n  query(options) {\n    var query = this.buildQueryParameters(options);\n\n    query.targets = query.targets.filter(t => !t.hide);\n    if (query.targets.length <= 0) {\n      return this.q.when({data: []});\n    }\n\n    var target = options.targets[0];\n    var path = '/api/cdn/v2/metrics/' + target.siteName + '/' + target.timeFrame + '/' + target.metricName + '?output=json';\n\n    return this.backendSrv.datasourceRequest({\n      url: this.url + path,\n      method: 'GET'\n    })\n    .then(response => {\n      response.data = this.formatRawBeluga(response);\n      return response;\n    });\n  }\n\n  formatRawBeluga(data) {\n    var output = [];\n    if (data.data.series) {\n      data = data.data.series;\n    }\n    _.map(data, (item, index) => {\n      var datapoints = _.map(data[index].data, (d) => {\n        return [d[1], d[0]];\n      });\n      output[index] = {\n        \"target\": data[index].name,\n        \"datapoints\": datapoints\n      };\n    });\n    return output;\n  }\n\n  testDatasource() {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/api/token/token',\n      method: 'GET'\n    }).then(response => {\n      if (response.status === 200) {\n        this.tokenObj = response.data;\n        return {\n          status: \"success\",\n          message: \"Data source is working\",\n          title: \"Success\"\n        };\n      }\n    });\n  }\n\n  // currently not being used\n  createAuthHeader(method, path) {\n    // Put together header to be HMAC-ed\n    var preHeader = method + \":\" + path + \":\";\n    var date = moment();\n    var tokenId = this.tokenObj.id;\n    var token = this.tokenObj.secret;\n    date = date.toISOString();\n    // date = date + \"Z\";\n    preHeader = preHeader + date;\n\n    // HMAC preHeader\n    var authHeader = CryptoJS.HmacSHA512(preHeader, token).toString();\n    authHeader = \"Token \" + tokenId + \" \" + authHeader;\n\n    return authHeader;\n  }\n\n  annotationQuery(options) {\n    var query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\n    var annotationQuery = {\n      range: options.range,\n      annotation: {\n        name: options.annotation.name,\n        datasource: options.annotation.datasource,\n        enable: options.annotation.enable,\n        iconColor: options.annotation.iconColor,\n        query: query\n      },\n      rangeRaw: options.rangeRaw\n    };\n\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/annotations',\n      method: 'POST',\n      data: annotationQuery\n    }).then(result => {\n      return result.data;\n    });\n  }\n\n  metricFindQuery(options, dimension) {\n    var path = '';\n    if (options === 'sites') {\n      path = \"/api/cdn/v2/\" + options;\n      this.currentDimension = options;\n    } else if (dimension === \"sites\") {\n      path = \"/api/cdn/v2/\" + dimension;\n      this.currentDimension = dimension;\n    }\n    else if (dimension === \"metrics\") {\n      path = \"/api/cdn/v2/\" + dimension + \"/\" + options.siteName;\n      this.currentDimension = \"views\";\n    }\n    else if (dimension === \"time_frame\"){\n      path = \"/api/cdn/v2/\" + \"metrics\" + \"/\" + options.siteName;\n      this.currentDimension = dimension;\n    } else {\n      path = \"\";\n    }\n\n    return this.backendSrv.datasourceRequest({\n      url: this.url + path,\n      method: 'GET'\n    }).then(this.mapToTextValue.bind(this));\n  }\n\n  mapToTextValue(result) {\n    var resultKeys = [];\n    resultKeys.push(this.currentDimension);\n\n    // parse available data responses based for metrics\n    // https://docs.belugacdn.com/v2/docs/metrics-list\n    if (this.currentDimension === 'views') {\n      resultKeys.push('codes');\n      resultKeys.push('fields');\n    }\n\n    // mock the `time_frame` response\n    result.data[\"time_frame\"] = [\n      {\"name\": \"hour\"},\n      {\"name\": \"day\"},\n      {\"name\": \"week\"},\n      {\"name\": \"month\"},\n      {\"name\": \"year\"}\n    ];\n\n    var response = [];\n    for (var i = 0;i < resultKeys.length;i++) {\n      var r = _.map(result.data[resultKeys[i]], (d) => {\n        return {\n          text: d.name,\n          value: d.name\n        };\n      });\n      response = response.concat(r);\n    }\n    return response;\n  }\n\n  buildQueryParameters(options) {\n    var targets = _.map(options.targets, target => {\n      return {\n        target: this.templateSrv.replace(target.target),\n        refId: target.refId,\n        hide: target.hide,\n        type: target.type || 'timeserie',\n        siteName: this.templateSrv.replace(target.siteName),\n        metricName: this.templateSrv.replace(target.metricName),\n        timeFrame: this.templateSrv.replace(target.timeFrame)\n      };\n    });\n\n    options.targets = targets;\n\n    return options;\n  }\n}\n"]}